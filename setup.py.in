#!/usr/bin/env python3
# Copyright 2020 Trail of Bits, all rights reserved.

import distutils.core
import os
import platform
import sys

if sys.version_info < (3, 7):
  print("Pasta is only supported on Python 3.7 and above.")
  sys.exit(1)

PASTA_SRC_DIR = "@CMAKE_CURRENT_SOURCE_DIR@"
PASTA_BIN_DIR = "@CMAKE_CURRENT_BINARY_DIR@"

os.environ["CC"] = "@CMAKE_C_COMPILER@"
os.environ["CXX"] = "@CMAKE_CXX_COMPILER@"

INCLUDE_DIRS = list(set("@INCLUDE_DIRS@".split(";")))
LIBRARY_PATHS = list(set("@LIBRARY_PATHS@".split(";")))

extra_link_args = []
extra_compile_args = ["-std=c++17"]

if sys.platform.startswith("linux"):
    extra_link_args = \
        ["-Wl,--whole-archive"] + \
        LIBRARY_PATHS + \
        ["-Wl,--no-whole-archive"] + \
        list(set("@CXX_FILESYSTEM_LIBS@".split(";")))
elif sys.platform == "darwin":
    extra_link_args = \
        ["-Wl,-force_load"] + \
        ["$<TARGET_FILE:pasta_python_bindings>"] + \
        LIBRARY_PATHS + \
        ['-stdlib=libc++']
    extra_compile_args += ['-stdlib=libc++']
else:
    print("Pasta is only supported on macOS and Linux")
    sys.exit(1)

pasta_internal = distutils.core.Extension(
    "pasta_internal",
    include_dirs=INCLUDE_DIRS,
    sources=[],
    language="c++",
    extra_compile_args=extra_compile_args,
    libraries=[],
    extra_link_args=extra_link_args)

distutils.core.setup(
    name="pasta",
    version="0.1",
    description="Peter's Amazing Syntax Tree Analyzer",
    author="Trail of Bits",
    author_email="peter@trailofbits.com",
    url="https://github.com/trailofbits/pasta",
    license="Proprietary and confidential",
    py_modules=["pasta.__init__"],
    ext_modules=[pasta_internal])
